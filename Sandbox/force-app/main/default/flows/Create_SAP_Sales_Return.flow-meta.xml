<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Create_query_for_invoice</name>
        <label>Create query for invoice</label>
        <locationX>182</locationX>
        <locationY>278</locationY>
        <actionName>overcast__ActionCreateRealtimeQuery</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Get_invoice_from_SAP</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>flow_fault</targetReference>
        </faultConnector>
        <flowTransactionModel>Automatic</flowTransactionModel>
        <inputParameters>
            <name>scenarioName</name>
            <value>
                <stringValue>BillingDocHeader</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>string0</name>
            <value>
                <elementReference>leftPaddedInvoiceNo</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>where_x</name>
            <value>
                <stringValue>{&quot;logicOperator&quot;:&quot;AND&quot;,&quot;conditionLogic&quot;:&quot;1&quot;,&quot;conditions&quot;:[{&quot;id&quot;:1,&quot;fieldName&quot;:&quot;VBELN&quot;,&quot;operator&quot;:&quot;EQUALS&quot;,&quot;value&quot;:&quot;leftPaddedInvoiceNo&quot;,&quot;isReference&quot;:true,&quot;propertyName&quot;:&quot;string0&quot;}]}</stringValue>
            </value>
        </inputParameters>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <actionCalls>
        <name>Create_query_for_ZREs</name>
        <label>Create query for ZREs</label>
        <locationX>226</locationX>
        <locationY>1118</locationY>
        <actionName>overcast__ActionCreateRealtimeQuery</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Get_ZREs_from_SAP</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>flow_fault</targetReference>
        </faultConnector>
        <flowTransactionModel>Automatic</flowTransactionModel>
        <inputParameters>
            <name>orderBy</name>
            <value>
                <stringValue>[{&quot;id&quot;:&quot;0.1355484601047845&quot;,&quot;columnName&quot;:&quot;CustomerReturn&quot;,&quot;ascending&quot;:false,&quot;ascendingText&quot;:&quot;DESC&quot;}]</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>scenarioName</name>
            <value>
                <stringValue>CustomerReturn</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>string0</name>
            <value>
                <elementReference>salesReturnType</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>string1</name>
            <value>
                <elementReference>enter_invoice_number</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>where_x</name>
            <value>
                <stringValue>{&quot;logicOperator&quot;:&quot;AND&quot;,&quot;conditionLogic&quot;:&quot;1 AND 2&quot;,&quot;conditions&quot;:[{&quot;id&quot;:1,&quot;fieldName&quot;:&quot;ReferenceSDDocument&quot;,&quot;operator&quot;:&quot;EQUALS&quot;,&quot;value&quot;:&quot;enter_invoice_number&quot;,&quot;isReference&quot;:true,&quot;propertyName&quot;:&quot;string1&quot;},{&quot;id&quot;:2,&quot;fieldName&quot;:&quot;CustomerReturnType&quot;,&quot;operator&quot;:&quot;EQUALS&quot;,&quot;value&quot;:&quot;{!salesReturnType}&quot;,&quot;isReference&quot;:true,&quot;propertyName&quot;:&quot;string0&quot;}]}</stringValue>
            </value>
        </inputParameters>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <actionCalls>
        <name>Get_invoice_from_SAP</name>
        <label>Get invoice from SAP</label>
        <locationX>182</locationX>
        <locationY>398</locationY>
        <actionName>BillingDocHeader</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Assign_returned_invoice_data</targetReference>
        </connector>
        <faultConnector>
            <isGoTo>true</isGoTo>
            <targetReference>flow_fault</targetReference>
        </faultConnector>
        <flowTransactionModel>Automatic</flowTransactionModel>
        <inputParameters>
            <name>doNotCommitLogs</name>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>flowInterviewGuid</name>
            <value>
                <elementReference>$Flow.InterviewGuid</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>query</name>
            <value>
                <elementReference>Create_query_for_invoice.query</elementReference>
            </value>
        </inputParameters>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <actionCalls>
        <name>Get_ZREs_from_SAP</name>
        <label>Get ZREs from SAP</label>
        <locationX>226</locationX>
        <locationY>1238</locationY>
        <actionName>CustomerReturn</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Get_header_data</targetReference>
        </connector>
        <faultConnector>
            <targetReference>flow_fault</targetReference>
        </faultConnector>
        <flowTransactionModel>Automatic</flowTransactionModel>
        <inputParameters>
            <name>flowInterviewGuid</name>
            <value>
                <elementReference>$Flow.InterviewGuid</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>logger</name>
            <value>
                <elementReference>Get_invoice_from_SAP.logger</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>operation</name>
            <value>
                <stringValue>Query</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>query</name>
            <value>
                <elementReference>Create_query_for_ZREs.query</elementReference>
            </value>
        </inputParameters>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </actionCalls>
    <apiVersion>54.0</apiVersion>
    <assignments>
        <name>Add_ZRE_number_to_collection</name>
        <label>Add ZRE number to collection</label>
        <locationX>314</locationX>
        <locationY>1598</locationY>
        <assignmentItems>
            <assignToReference>returnedZREs</assignToReference>
            <operator>Add</operator>
            <value>
                <stringValue>{!lineBreak}　● {!Loop_over_ZRE_headers.CustomerReturn}</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_over_ZRE_headers</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_returned_invoice_data</name>
        <label>Assign returned invoice data</label>
        <locationX>182</locationX>
        <locationY>518</locationY>
        <assignmentItems>
            <assignToReference>invoiceResponse</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_invoice_from_SAP.response</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>invoiceCount</assignToReference>
            <operator>AssignCount</operator>
            <value>
                <elementReference>invoiceResponse.VBRK</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Check_if_invoice_was_returned</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_slp_parameters_output</name>
        <label>Assign slp parameters output</label>
        <locationX>226</locationX>
        <locationY>2270</locationY>
        <assignmentItems>
            <assignToReference>slpParamsOutput</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>slpParamsTemplate</elementReference>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Assign_value_to_Invoice_Get_Detail_entity</name>
        <label>Assign value to Invoice Get-Detail entity</label>
        <locationX>226</locationX>
        <locationY>2150</locationY>
        <assignmentItems>
            <assignToReference>webInvoiceGetDetailEntity.BILLINGDOC</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>leftPaddedInvoiceNo</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Assign_slp_parameters_output</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Get_header_data</name>
        <label>Get header data</label>
        <locationX>226</locationX>
        <locationY>1358</locationY>
        <assignmentItems>
            <assignToReference>headersForZREs</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Get_ZREs_from_SAP.response.A_CustomerReturn</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_over_ZRE_headers</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>get_values_from_invoice_header</name>
        <label>Get values from invoice header</label>
        <locationX>666</locationX>
        <locationY>878</locationY>
        <assignmentItems>
            <assignToReference>invoiceType</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_over_invoice_headers.FKART</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>check_invoice_type</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Check_if_invoice_was_returned</name>
        <label>Check if invoice was returned</label>
        <locationX>182</locationX>
        <locationY>638</locationY>
        <defaultConnector>
            <targetReference>No_invoice_found</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No invoice returned</defaultConnectorLabel>
        <rules>
            <name>invoice_returned</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>invoiceCount</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <numberValue>0.0</numberValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Loop_over_invoice_headers</targetReference>
            </connector>
            <label>Invoice returned</label>
        </rules>
    </decisions>
    <decisions>
        <name>check_invoice_type</name>
        <label>Check Invoice Type</label>
        <locationX>666</locationX>
        <locationY>998</locationY>
        <defaultConnector>
            <targetReference>wrong_invoice_type</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Not acceptable type</defaultConnectorLabel>
        <rules>
            <name>matches_acceptable_types</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>invoiceType</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>ZKF2</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>invoiceType</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>ZF2</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>invoiceType</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>ZLF2</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Create_query_for_ZREs</targetReference>
            </connector>
            <label>Matches acceptable types</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_returned_ZRE_numbers</name>
        <label>Check returned ZRE numbers</label>
        <locationX>226</locationX>
        <locationY>1814</locationY>
        <defaultConnector>
            <targetReference>Returns_with_invoice_reference</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>ZRE(s) returned</defaultConnectorLabel>
        <rules>
            <name>None_returned</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>returnedZREs</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue></stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_value_to_Invoice_Get_Detail_entity</targetReference>
            </connector>
            <label>None returned</label>
        </rules>
    </decisions>
    <formulas>
        <name>leftPaddedInvoiceNo</name>
        <dataType>String</dataType>
        <expression>LPAD({!enter_invoice_number}, 10, &apos;0&apos;)</expression>
    </formulas>
    <formulas>
        <name>lineBreak</name>
        <dataType>String</dataType>
        <expression>BR()</expression>
    </formulas>
    <interviewLabel>Create SAP Sales Return {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Create SAP Sales Return</label>
    <loops>
        <name>Loop_over_invoice_headers</name>
        <label>Loop over invoice headers</label>
        <locationX>50</locationX>
        <locationY>758</locationY>
        <collectionReference>invoiceResponse.VBRK</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>get_values_from_invoice_header</targetReference>
        </nextValueConnector>
    </loops>
    <loops>
        <name>Loop_over_ZRE_headers</name>
        <label>Loop over ZRE headers</label>
        <locationX>226</locationX>
        <locationY>1478</locationY>
        <collectionReference>headersForZREs</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Add_ZRE_number_to_collection</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Check_returned_ZRE_numbers</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>Flow</processType>
    <screens>
        <name>flow_fault</name>
        <label>Flow fault</label>
        <locationX>578</locationX>
        <locationY>1358</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <fields>
            <name>fault_message</name>
            <fieldText>&lt;p&gt;&lt;span style=&quot;color: rgb(255, 0, 0);&quot;&gt;{!$Flow.FaultMessage}&lt;/span&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>invoice_number_input</name>
        <label>Invoice number input</label>
        <locationX>182</locationX>
        <locationY>158</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>Create_query_for_invoice</targetReference>
        </connector>
        <fields>
            <name>enter_invoice_number</name>
            <dataType>String</dataType>
            <fieldText>Please enter the invoice number</fieldText>
            <fieldType>InputField</fieldType>
            <isRequired>true</isRequired>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>No_invoice_found</name>
        <label>No invoice found</label>
        <locationX>314</locationX>
        <locationY>758</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <fields>
            <name>display_no_invoice_found_message</name>
            <fieldText>&lt;p&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;Invoice {!enter_invoice_number} could not be found in SAP. Please confirm the invoice number you have entered is correct.&lt;/span&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Returns_with_invoice_reference</name>
        <label>Returns with invoice reference</label>
        <locationX>314</locationX>
        <locationY>1934</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <connector>
            <targetReference>Assign_value_to_Invoice_Get_Detail_entity</targetReference>
        </connector>
        <fields>
            <name>show_ZREs_with_invoice_reference</name>
            <fieldText>&lt;p&gt;{!templateForReturnedZREs}&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>wrong_invoice_type</name>
        <label>Wrong invoice type</label>
        <locationX>1106</locationX>
        <locationY>1118</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>false</allowPause>
        <fields>
            <name>show_validation_failed_message</name>
            <fieldText>&lt;p&gt;&lt;b style=&quot;color: rgb(255, 0, 0);&quot;&gt;Validation Failed:&lt;/b&gt; Invoice {!enter_invoice_number} is of the wrong type ({!invoiceType}) for a ZRE Sales Return&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <start>
        <locationX>56</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>invoice_number_input</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <textTemplates>
        <name>slpParamsTemplate</name>
        <isViewedAsPlainText>true</isViewedAsPlainText>
        <text>{&quot;BAPI_WEBINVOICE_GETDETAIL&quot;:{!webInvoiceGetDetailEntity}}</text>
    </textTemplates>
    <textTemplates>
        <name>templateForReturnedZREs</name>
        <isViewedAsPlainText>false</isViewedAsPlainText>
        <text>&lt;p&gt;&lt;span style=&quot;color: rgb(68, 68, 68); background-color: rgb(255, 255, 255);&quot;&gt;Invoice {!enter_invoice_number} is already referenced in the following Sales Returns: {!returnedZREs}&lt;/span&gt;&lt;/p&gt;</text>
    </textTemplates>
    <variables>
        <name>headersForZREs</name>
        <apexClass>CustomerReturnA_CustomerReturn</apexClass>
        <dataType>Apex</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>invoiceCount</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>0.0</numberValue>
        </value>
    </variables>
    <variables>
        <name>invoiceResponse</name>
        <apexClass>BillingDocHeader</apexClass>
        <dataType>Apex</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>invoiceType</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>recordId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>returnedZREs</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <stringValue></stringValue>
        </value>
    </variables>
    <variables>
        <name>salesReturnType</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>slpParamsOutput</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>webInvoiceGetDetailEntity</name>
        <apexClass>sapInvoiceDetailBAPIWEBINVOICEGETDETAIL</apexClass>
        <dataType>Apex</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
